#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>
#include <semaphore.h>
/* Global variables */
int x = 0;
sem_t sync_1;
sem_t sync_2;

void a_1()
{
    sleep(4);
    printf("X = %d\n", x);
    x = 55;
    printf("A1 vient de s'executer\n");
}

void a_2()
{
    sleep(2);
    printf("A2 vient de s'executer\n");
}

/* Thread function */
void *p1(void *arg)
{
    a_1();
    sem_post(sync_2);
    sem_wait(sync_1);
    a_2();
}

void b_1()
{
    sleep(1);
    printf("X = %d\n", x);
    printf("B1 vient de s'executer\n");
}

void b_2()
{
    printf("B2 vient de s'executer\n");
}

void *p2(void *arg)
{
    b_1();
    sem_wait(sync_2);
    sem_post(sync_1);
    b_2();
}

void main()
{
    pthread_t thread1, thread2;
    sync_1 = sem_open("/sync_x", O_CREAT, 0644, 0);
    sync_2 = sem_open("/sync_y", O_CREAT, 0644, 0);

    if (pthread_create(&thread1, NULL, p1, NULL) < 0)
    {
        perror("Error: thread cannot be created");
        exit(1);
    }
    if (pthread_create(&thread2, NULL, p2, NULL) < 0)
    {
        perror("Error: thread cannot be created");
        exit(1);
    }
    /* wait for created thread to terminate */
    pthread_join(thread1, NULL);
    pthread_join(thread2, NULL);
    /* destroy semaphore sync_x */
    sem_destroy(&sync_1);
    sem_destroy(&sync_2);
    exit(0);
}
