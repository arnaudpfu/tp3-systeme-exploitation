#include <semaphore.h>
#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>

#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <semaphore.h>

#define BUFFER_SIZE 10

char *buffer[BUFFER_SIZE];
int count = 0;
int in = 0;
int out = 0;
int message_index = 0;

sem_t *mutex, *full, *empty;

void produire(char *message)
{
    message = (char *)malloc(sizeof(char) * 20);
    sprintf(message, "Message : %d", message_index++);
}

void deposer(char *message)
{
    buffer[in] = *message;
    in = (in + 1) % BUFFER_SIZE;
    count++;
}

void *producteur(void *arg)
{
    char *message;
    while (1)
    {
        message = (char *)malloc(sizeof(char) * 20);
        sprintf(message, "Message : %d", message_index++);

        sem_wait(empty);
        sem_wait(mutex);

        buffer[in] = message;
        in = (in + 1) % BUFFER_SIZE;
        count++;

        sem_post(mutex);
        sem_post(full);
    }
    return NULL;
}

void *consommateur(void *arg)
{
    char *message;
    while (1)
    {
        sem_wait(full);
        sem_wait(mutex);

        message = buffer[out];
        out = (out + 1) % BUFFER_SIZE;
        count--;

        sem_post(mutex);
        sem_post(empty);

        printf("%s\n", message);
        free(message);
    }
    return NULL;
}

int main()
{
    mutex = sem_open("/semaphore_mutex", O_CREAT, 0644, 1);
    full = sem_open("/semaphore_full", O_CREAT, 0644, 0);
    empty = sem_open("/semaphore_empty", O_CREAT, 0644, BUFFER_SIZE);

    pthread_t prod_tid, cons_tid;

    if (pthread_create(&prod_tid, NULL, producteur, NULL) < 0)
    {
        perror("Error: productor cannot be created");
        exit(1);
    }

    if (pthread_create(&cons_tid, NULL, consommateur, NULL) < 0)
    {
        perror("Error: consommateur cannot be created");
        exit(1);
    }

    pthread_join(prod_tid, NULL);
    pthread_join(cons_tid, NULL);

    sem_destroy(&mutex);
    sem_destroy(&full);
    sem_destroy(&empty);

    sem_close(mutex);
    sem_close(full);
    sem_close(empty);

    sem_unlink("/semaphore_mutex");
    sem_unlink("/semaphore_full");
    sem_unlink("/semaphore_empty");

    return 0;
}
